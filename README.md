# Taking Stock - Fast Database

Analytics backend and AI-powered query interface for Michael Mandiberg's [Taking Stock](https://verse.works/series/taking-stock-by-michael-mandiberg) artwork.

## Overview

This project migrates the Taking Stock database from MySQL/MongoDB to ClickHouse for fast analytical queries over **tens of millions of stock photos**. It provides an AI-queryable interface via MCP (Model Context Protocol) and a web chat UI for natural language data exploration.

The MooseStack service runs ClickHouse and exposes an MCP server. The web app provides a chat interface where users ask questions in natural language, Claude generates SQL queries via MCP tools, and results are returned for display.

### Architecture

This is a pnpm monorepo with three packages:

**`packages/moosestack-service/`** — ClickHouse-backed data service with MCP server. Handles data ingestion and exposes query tools via API at `http://localhost:4000`.

**`packages/web-app/`** — Next.js chat interface for AI-powered data exploration. Connects to MooseStack MCP server and uses Anthropic Claude for query generation.

**`packages/data-faker/`** — Test data generator for performance testing. Generates realistic variant data matching the `images_analytical` schema with checkpoint/resume support. See [data-faker README](./packages/data-faker/README.md) for details.

## Getting Started

Clone and install dependencies:

```bash
pnpm install
```

Copy example environment variables

```bash
cp packages/moosestack-service/.env.{example,local}
cp packages/web-app/.env.{example,local}
```

Create API Key authentication tokens

```bash
$ cd packages/moosestack-service
moose generate hash-token # use output for the API Key & Token below
```

Set environment variables

1. Set your API Key in packages/moosestack-service/.env.local to the `ENV API KEY` generated by moose generate hash-token
2. Set your API Token in packages/web-app/.env.local to the `Bearer Token` generated by moose generate hash-token
3. Set your Anthropic API key in packages/web-app/.env.local

Start both services:

```bash
pnpm dev
```

Or start services individually:

```bash
pnpm dev:moose    # Start MooseStack service only
pnpm dev:web      # Start web app only
pnpm dev:faker    # Run data faker (generates test data)
```

### Data Faker

The `data-faker` package generates realistic test data for performance testing. It supports checkpoint/resume, graceful shutdown, and generates ~100GB of variant data.

**Quick start:**
```bash
# Quick test (100 rows)
pnpm dev:faker --rows 100

# Check current row count
pnpm dev:faker --count

# Full scale (100GB, ~200M rows)
pnpm dev:faker --rows 200000000

# Resume from checkpoint
pnpm dev:faker
```

See [packages/data-faker/README.md](./packages/data-faker/README.md) for complete documentation.

**Note:** The data faker requires MooseStack service to be running (or at least ClickHouse accessible) to insert data. Run `pnpm dev:moose` first if ClickHouse isn't already running.

## Performance

Benchmarks over **65 million rows** (8 GB compressed, 15 GB uncompressed):

| Query Type | Time |
|------------|------|
| Simple aggregations | ~300ms |
| Cross-tabulations (gender × region) | ~300ms |
| Multi-filter queries | ~300ms |
| Full table scans | ~300ms |

ClickHouse scans 15 GB of data at ~25 GB/sec on a laptop. See [Performance Benchmarks](./speed-tests.md) for full methodology and results.

## MCP Tools Available

- **`query_clickhouse`** - Execute read-only SQL queries against ClickHouse with automatic result limiting
- **`get_data_catalog`** - Discover available tables and views with their schema information

## Learn More

- [Data Migration Plan](./data-migration.md) - Strategy for migrating from MySQL/MongoDB to ClickHouse
- [Performance Benchmarks](./speed-tests.md) - Query speed tests over 65M rows
- [Development Guide](./development.md) - Data models and ingestion API
- [Security](./security.md) - Security features and production considerations
- [MooseStack Documentation](https://docs.moosejs.com)
- [Model Context Protocol](https://modelcontextprotocol.io)
- [MCP SDK (@modelcontextprotocol/sdk)](https://github.com/modelcontextprotocol/typescript-sdk)
- [WebApp Class Reference](https://docs.moosejs.com/building-moose-apps/custom-apis)

---

Built with [MooseStack](https://www.moosejs.com/) by [Fiveonefour](https://www.fiveonefour.com/)
